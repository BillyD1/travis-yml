#!/usr/bin/env ruby

$: << 'lib'

require 'benchmark'
require 'yaml'
require 'travis/yaml'

yaml = %(
  # from rails/rails
  script: 'ci/travis.rb'
  before_install:
    - travis_retry gem install bundler
    - "rvm current | grep 'jruby' && export AR_JDBC=true || echo"
  rvm:
    - 1.9.3
    - 2.0.0
    - 2.1.1
    - rbx-2
    - jruby
  env:
    - "GEM=railties"
    - "GEM=ap,am,amo,as,av"
    - "GEM=ar:mysql"
    - "GEM=ar:mysql2"
    - "GEM=ar:sqlite3"
    - "GEM=ar:postgresql"
  matrix:
    allow_failures:
      - rvm: rbx-2
      - rvm: jruby
    fast_finish: true
  notifications:
    email: false
    irc:
      on_success: change
      on_failure: always
      channels:
        - "irc.freenode.org#rails-contrib"
    campfire:
      on_success: change
      on_failure: always
  bundler_args: --path vendor/bundle --without test
  services:
    - memcached
)

config = YAML.load(yaml)
count = 1000

GC.disable
Benchmark.bm do |x|
  x.report do
    count.times do |ix|
      print "\r\e[2K#{ix}"
      Travis::Yaml.apply(config).serialize
    end
    print "\r\e[2K"
  end
end
